<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Người dùng - Admin</title>
    <link rel="stylesheet" href="/css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <nav class="admin-sidebar">
            <div class="sidebar-header">
                <h3><i class="fas fa-cogs"></i> Admin Panel</h3>
            </div>
            <ul class="sidebar-menu">
                <li><a href="/admin/dashboard"><i class="fas fa-chart-line"></i> Dashboard</a></li>
                <li class="active"><a href="/admin/users"><i class="fas fa-users"></i> Quản lý người dùng</a></li>
                <li><a href="/admin/products"><i class="fas fa-box"></i> Quản lý sản phẩm</a></li>
                <li><a href="/admin/categories"><i class="fas fa-tags"></i> Danh mục</a></li>
                <li><a href="/admin/brands"><i class="fas fa-trademark"></i> Thương hiệu</a></li>
                <li><a href="/admin/banners"><i class="fas fa-image"></i> Quản lý Banner</a></li>
                <li><a href="/admin/sports"><i class="fas fa-running"></i> Quản lý Môn Thể Thao</a></li>
                <li><a href="/"><i class="fas fa-home"></i> Về trang chủ</a></li>
                <li><a href="/logout"><i class="fas fa-sign-out-alt"></i> Đăng xuất</a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <div class="admin-main">
            <!-- Header -->
            <div class="admin-header">
                <h1><i class="fas fa-users"></i> Quản lý Người dùng</h1>
                <div class="admin-user">
                    <span th:if="${#authentication.principal instanceof T(com.example.datn.auth.CustomUserDetails)}">
                        Xin chào, <strong th:text="${#authentication.principal.domainUser.ten}">Admin</strong>
                    </span>
                </div>
            </div>

            <!-- Content -->
            <div class="admin-content">
                <!-- Flash Messages -->
                <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle"></i> <span th:text="${successMessage}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-circle"></i> <span th:text="${errorMessage}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>

                <!-- Statistics Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon users">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-info">
                                <h3 th:text="${users.totalElements}">0</h3>
                                <p>Tổng người dùng</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon active">
                                <i class="fas fa-user-check"></i>
                            </div>
                            <div class="stat-info">
                                <h3 th:text="${activeUsers}">0</h3>
                                <p>Đang hoạt động</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon locked">
                                <i class="fas fa-user-lock"></i>
                            </div>
                            <div class="stat-info">
                                <h3 th:text="${lockedUsers}">0</h3>
                                <p>Bị khóa</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon new">
                                <i class="fas fa-user-plus"></i>
                            </div>
                            <div class="stat-info">
                                <h3 th:text="${newUsers}">0</h3>
                                <p>Mới hôm nay</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Search and Filters -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-search"></i> Tìm kiếm và Lọc
                        </h5>
                    </div>
                    <div class="card-body">
                        <form method="get" class="row g-3">
                            <div class="col-md-4">
                                <label for="search" class="form-label">Tìm kiếm</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                    <input type="text" 
                                           class="form-control" 
                                           id="search" 
                                           name="search" 
                                           th:value="${search}"
                                           placeholder="Tên, email, số điện thoại...">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label for="role" class="form-label">Vai trò</label>
                                <select class="form-select" id="role" name="role">
                                    <option value="">Tất cả vai trò</option>
                                    <option th:each="role : ${roles}" 
                                            th:value="${role.id}" 
                                            th:text="${role.tenVaiTro}"
                                            th:selected="${role.id == selectedRole}">Vai trò</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="status" class="form-label">Trạng thái</label>
                                <select class="form-select" id="status" name="status">
                                    <option value="">Tất cả trạng thái</option>
                                    <option value="active" th:selected="${selectedStatus == 'active'}">Đang hoạt động</option>
                                    <option value="locked" th:selected="${selectedStatus == 'locked'}">Bị khóa</option>
                                    <option value="inactive" th:selected="${selectedStatus == 'inactive'}">Không hoạt động</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-search"></i> Tìm kiếm
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Users Table -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-list"></i> Danh sách Người dùng
                        </h5>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="exportUsers()">
                                <i class="fas fa-download"></i> Xuất Excel
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="refreshPage()">
                                <i class="fas fa-sync-alt"></i> Làm mới
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th width="50">
                                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                        </th>
                                        <th width="60">Avatar</th>
                                        <th>Thông tin</th>
                                        <th>Liên hệ</th>
                                        <th>Vai trò</th>
                                        <th>Trạng thái</th>
                                        <th>Ngày tạo</th>
                                        <th width="120">Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="user : ${users.content}">
                                        <td>
                                            <input type="checkbox" class="user-checkbox" th:value="${user.id}">
                                        </td>
                                        <td>
                                            <div class="user-avatar">
                                                <img th:if="${user.avatarUrl != null and !user.avatarUrl.isEmpty()}" 
                                                     th:src="${user.avatarUrl}" 
                                                     th:alt="${user.ten}"
                                                     class="avatar-img">
                                                <div th:unless="${user.avatarUrl != null and !user.avatarUrl.isEmpty()}" 
                                                     class="avatar-placeholder">
                                                    <i class="fas fa-user"></i>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="user-info">
                                                <h6 class="mb-1" th:text="${user.ten}">Tên người dùng</h6>
                                                <small class="text-muted" th:text="${user.email}">email@example.com</small>
                                                <div class="user-badges mt-1">
                                                    <span th:if="${user.provider == 'GOOGLE'}" class="badge bg-danger">
                                                        <i class="fab fa-google"></i> Google
                                                    </span>
                                                    <span th:unless="${user.provider == 'GOOGLE'}" class="badge bg-primary">
                                                        <i class="fas fa-envelope"></i> Email
                                                    </span>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="contact-info">
                                                <div th:if="${user.soDienThoai != null and !user.soDienThoai.isEmpty()}">
                                                    <i class="fas fa-phone text-success"></i>
                                                    <span th:text="${user.soDienThoai}">0123456789</span>
                                                </div>
                                                <div th:if="${user.diaChi != null and !user.diaChi.isEmpty()}">
                                                    <i class="fas fa-map-marker-alt text-info"></i>
                                                    <span th:text="${user.diaChi}">Địa chỉ</span>
                                                </div>
                                                <div th:if="${user.thanhPho != null and !user.thanhPho.isEmpty()}">
                                                    <i class="fas fa-city text-warning"></i>
                                                    <span th:text="${user.thanhPho}">Thành phố</span>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary" th:text="${user.vaiTro.tenVaiTro}">Vai trò</span>
                                        </td>
                                        <td>
                                            <div class="status-badges">
                                                <span th:if="${user.hoatDong}" class="badge bg-success">
                                                    <i class="fas fa-check"></i> Hoạt động
                                                </span>
                                                <span th:unless="${user.hoatDong}" class="badge bg-danger">
                                                    <i class="fas fa-times"></i> Tạm dừng
                                                </span>
                                                <br>
                                                <span th:if="${user.biKhoa}" class="badge bg-warning mt-1">
                                                    <i class="fas fa-lock"></i> Bị khóa
                                                </span>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="date-info">
                                                <div th:text="${#temporals.format(user.ngayTao, 'dd/MM/yyyy')}">01/01/2024</div>
                                                <small class="text-muted" th:text="${#temporals.format(user.ngayTao, 'HH:mm')}">12:00</small>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <button type="button" 
                                                        class="btn btn-sm btn-outline-info" 
                                                        th:onclick="'viewUser(' + ${user.id} + ')'"
                                                        title="Xem chi tiết">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button type="button" 
                                                        class="btn btn-sm btn-outline-warning" 
                                                        th:onclick="'editUser(' + ${user.id} + ')'"
                                                        title="Chỉnh sửa">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button type="button" 
                                                        class="btn btn-sm btn-outline-danger" 
                                                        th:onclick="'toggleUserStatus(' + ${user.id} + ')'"
                                                        th:title="${user.hoatDong ? 'Tạm dừng' : 'Kích hoạt'}"
                                                        th:class="${user.hoatDong ? 'btn-outline-warning' : 'btn-outline-success'}">
                                                    <i class="fas" th:class="${user.hoatDong ? 'fa-pause' : 'fa-play'}"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Pagination -->
                <nav th:if="${users.totalPages > 1}" aria-label="Page navigation" class="mt-4">
                    <ul class="pagination justify-content-center">
                        <li class="page-item" th:classappend="${users.first} ? 'disabled'">
                            <a class="page-link" th:href="@{/admin/users(page=0, search=${search}, role=${selectedRole}, status=${selectedStatus})}">
                                <i class="fas fa-angle-double-left"></i>
                            </a>
                        </li>
                        <li class="page-item" th:classappend="${users.first} ? 'disabled'">
                            <a class="page-link" th:href="@{/admin/users(page=${users.number - 1}, search=${search}, role=${selectedRole}, status=${selectedStatus})}">
                                <i class="fas fa-angle-left"></i>
                            </a>
                        </li>
                        <li class="page-item" th:each="i : ${#numbers.sequence(0, users.totalPages - 1)}" 
                            th:classappend="${i == users.number} ? 'active'">
                            <a class="page-link" th:href="@{/admin/users(page=${i}, search=${search}, role=${selectedRole}, status=${selectedStatus})}" 
                               th:text="${i + 1}">1</a>
                        </li>
                        <li class="page-item" th:classappend="${users.last} ? 'disabled'">
                            <a class="page-link" th:href="@{/admin/users(page=${users.number + 1}, search=${search}, role=${selectedRole}, status=${selectedStatus})}">
                                <i class="fas fa-angle-right"></i>
                            </a>
                        </li>
                        <li class="page-item" th:classappend="${users.last} ? 'disabled'">
                            <a class="page-link" th:href="@{/admin/users(page=${users.totalPages - 1}, search=${search}, role=${selectedRole}, status=${selectedStatus})}">
                                <i class="fas fa-angle-double-right"></i>
                            </a>
                        </li>
                    </ul>
                </nav>

                <!-- No Data Message -->
                <div th:if="${users.isEmpty()}" class="text-center py-5">
                    <i class="fas fa-users fa-3x text-muted mb-3"></i>
                    <h4>Không tìm thấy người dùng</h4>
                    <p class="text-muted">Hãy thử thay đổi bộ lọc tìm kiếm!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- User Detail Modal -->
    <div class="modal fade" id="userDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chi tiết Người dùng</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="userDetailContent">
                    <!-- Content will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.user-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }

        function viewUser(userId) {
            // Load user details via AJAX
            fetch(`/admin/users/${userId}`)
                .then(response => response.text())
                .then(html => {
                    document.getElementById('userDetailContent').innerHTML = html;
                    new bootstrap.Modal(document.getElementById('userDetailModal')).show();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra khi tải thông tin người dùng');
                });
        }

        function editUser(userId) {
            window.location.href = `/admin/users/edit/${userId}`;
        }

        function toggleUserStatus(userId) {
            if (confirm('Bạn có chắc chắn muốn thay đổi trạng thái người dùng này không?')) {
                const form = document.createElement('form');
                form.method = 'post';
                form.action = `/admin/users/toggle/${userId}`;
                document.body.appendChild(form);
                form.submit();
            }
        }

        function exportUsers() {
            const search = document.querySelector('input[name="search"]').value;
            const role = document.querySelector('select[name="role"]').value;
            const status = document.querySelector('select[name="status"]').value;
            
            let url = '/admin/users/export?';
            if (search) url += `search=${encodeURIComponent(search)}&`;
            if (role) url += `role=${role}&`;
            if (status) url += `status=${status}&`;
            
            window.open(url, '_blank');
        }

        function refreshPage() {
            window.location.reload();
        }
    </script>

    <style>
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            font-size: 1.5rem;
            color: white;
        }

        .stat-icon.users { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .stat-icon.active { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .stat-icon.locked { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .stat-icon.new { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }

        .stat-info h3 {
            font-size: 2rem;
            font-weight: 700;
            color: #495057;
            margin-bottom: 0.25rem;
        }

        .stat-info p {
            color: #6c757d;
            margin: 0;
            font-size: 0.9rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            position: relative;
        }

        .avatar-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-placeholder {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        .user-info h6 {
            font-weight: 600;
            color: #495057;
        }

        .user-badges .badge {
            font-size: 0.7rem;
        }

        .contact-info div {
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }

        .contact-info i {
            width: 16px;
            margin-right: 0.5rem;
        }

        .status-badges .badge {
            font-size: 0.75rem;
            margin-bottom: 0.25rem;
        }

        .date-info {
            font-size: 0.9rem;
        }

        .table th {
            border-top: none;
            font-weight: 600;
            color: #495057;
            background-color: #f8f9fa;
        }

        .table td {
            vertical-align: middle;
            border-color: #e9ecef;
        }

        .btn-group .btn {
            border-radius: 6px;
            margin-right: 2px;
        }

        .btn-group .btn:last-child {
            margin-right: 0;
        }

        .pagination .page-link {
            border-radius: 6px;
            margin: 0 2px;
            border: 1px solid #dee2e6;
        }

        .pagination .page-item.active .page-link {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }

        .card {
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 12px;
        }

        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            border-radius: 12px 12px 0 0 !important;
        }

        .alert {
            border: none;
            border-radius: 8px;
        }

        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid #ced4da;
        }

        .form-control:focus, .form-select:focus {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

        .input-group-text {
            background-color: #f8f9fa;
            border: 1px solid #ced4da;
        }
    </style>
</body>
</html>